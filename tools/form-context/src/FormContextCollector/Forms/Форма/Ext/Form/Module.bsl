 
// Переменные модуля для работы с TestClient API
&НаКлиенте
Перем МенеджерVA;             // Ссылка на менеджер Vanessa Automation
&НаКлиенте
Перем ТестируемоеОкно;        // ТестируемоеОкноКлиентскогоПриложения
&НаКлиенте
Перем ТестируемаяФорма;       // ТестируемаяФорма
&НаКлиенте
Перем ТекущаяГлубина;         // Число - для отслеживания вложенности

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// Проверка, что форма открыта из контекста Vanessa Automation
	Если МенеджерVA = Неопределено Тогда
		Если ВладелецФормы <> Неопределено Тогда
			МенеджерVA = ВладелецФормы;
		Иначе
			Предупреждение("Обработка должна быть открыта из Vanessa Automation!" + Символы.ПС +
				"Используйте метод ИнициализацияФормы() для передачи ссылки на VA.");
			Отказ = Истина;
			Возврат;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Инициализация значений по умолчанию для реквизитов
	Если ПустаяСтрока(Объект.ПутьКФайлуВыгрузки) Тогда
		Объект.ПутьКФайлуВыгрузки = ПолучитьИмяВременногоФайла("json");
	КонецЕсли;
	
	// Установка значений по умолчанию для настроек
	Объект.ВключатьТабличныеЧасти = Истина;
	Объект.ВключатьКоманды = Истина;
	Объект.МаксимальнаяГлубинаВложенности = 5;
	Объект.ВключатьНевидимыеЭлементы = Ложь;
	
	СтатусСбора = "Готов к работе";
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ПутьКФайлуВыгрузкиНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
	Диалог.Заголовок = "Выберите файл для сохранения результата";
	Диалог.ПолноеИмяФайла = Объект.ПутьКФайлуВыгрузки;
	Диалог.Фильтр = "JSON файлы (*.json)|*.json";
	
	Если Диалог.Выбрать() Тогда
		Объект.ПутьКФайлуВыгрузки = Диалог.ПолноеИмяФайла;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СобратьКонтекстФормы(Команда)
	СтатусСбора = "Выполняется сбор...";
	
	Попытка
		// 1. Инициализация подключения к TestClient
		ИнициализироватьТестируемуюФорму();
		
		// 2. Сбор информации о форме
		ДанныеФормы = СобратьИнформациюОФорме();
		
		// 3. Формирование JSON
		РезультатJSON = ПреобразоватьВJSON(ДанныеФормы);
		РезультатСбора = РезультатJSON;
		
		// 4. Сохранение в файл
		Если Не ПустаяСтрока(Объект.ПутьКФайлуВыгрузки) Тогда
			СохранитьВФайл(РезультатJSON);
			СтатусСбора = "Сбор завершен. Файл сохранен: " + Объект.ПутьКФайлуВыгрузки;
		Иначе
			СтатусСбора = "Сбор завершен. Файл не сохранен.";
		КонецЕсли;
		
	Исключение
		СтатусСбора = "Ошибка: " + ОписаниеОшибки();
		РезультатСбора = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	КонецПопытки;
КонецПроцедуры
 
&НаКлиенте
Процедура Очистить(Команда)
	РезультатСбора = "";
	СтатусСбора = "Готов к работе";
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиОповещений

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Инициализирует форму с передачей ссылки на Vanessa Automation
// Вызывается из Vanessa Automation при открытии формы
//
// Параметры:
//   ВладелецФормы - Объект - Ссылка на объект Vanessa Automation
//
&НаКлиенте
Функция ИнициализацияФормы(ВладелецФормы) Экспорт
	МенеджерVA = ВладелецФормы;
	Возврат Истина;
КонецФункции

// Инициализирует подключение к TestClient и получает ссылку на тестируемую форму
//
// Возвращаемое значение:
//   Булево - Истина, если инициализация прошла успешно
//
&НаКлиенте
Функция ИнициализироватьТестируемуюФорму()
	
	Попытка
		// Получаем контекст Vanessa Automation
		// Предполагается, что форма открыта из контекста VA
		Если МенеджерVA = Неопределено Тогда
			// Пытаемся получить владельца формы (если форма открыта из VA)
			Если ВладелецФормы <> Неопределено Тогда
				МенеджерVA = ВладелецФормы;
			Иначе
				ВызватьИсключение "Не удалось получить ссылку на Vanessa Automation. " +
					"Обработка должна быть открыта из контекста Vanessa Automation.";
			КонецЕсли;
		КонецЕсли;
		
		// Проверяем наличие TestClient API
		Если Не МенеджерVA.Свойство("ОбъектКонтекстСохраняемый") Тогда
			ВызватьИсключение "Не найден объект контекста Vanessa Automation. " +
				"Убедитесь, что TestClient подключен.";
		КонецЕсли;
		
		КонтекстСохраняемый = МенеджерVA.ОбъектКонтекстСохраняемый;
		
		Если Не КонтекстСохраняемый.Свойство("ТестовоеПриложение") Тогда
			ВызватьИсключение "TestClient не подключен. " +
				"Запустите сценарий и убедитесь, что клиент тестирования активен.";
		КонецЕсли;
		
		// Получаем активное окно TestClient
		ДопПараметры = Новый Структура;
		ДопПараметры.Вставить("ИскатьМодальныйДиалог", Истина);
		
		ТестируемоеОкно = МенеджерVA.ПолучитьАктивноеОкноИзТестовоеПриложение(ДопПараметры);
		
		Если ТестируемоеОкно = Неопределено Тогда
			ВызватьИсключение "Не найдено активное окно в клиенте тестирования. " +
				"Откройте форму, контекст которой нужно собрать.";
		КонецЕсли;
		
		// Получаем активную форму из окна
		ТестируемаяФорма = ТестируемоеОкно.НайтиОбъект(Тип("ТестируемаяФорма"));
		
		Если ТестируемаяФорма = Неопределено Тогда
			ВызватьИсключение "В активном окне не найдена форма. " +
				"Убедитесь, что в клиенте тестирования открыта форма.";
		КонецЕсли;
		
		Возврат Истина;
		
	Исключение
		ВызватьИсключение "Ошибка инициализации TestClient: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

// Собирает информацию о форме и её элементах
//
// Возвращаемое значение:
//   Структура - Структура с данными о форме
//
&НаКлиенте
Функция СобратьИнформациюОФорме()
	
	// Создаем структуру для хранения данных
	ДанныеФормы = Новый Структура;
	ДанныеФормы.Вставить("form_name", "");
	ДанныеФормы.Вставить("form_type", "");
	ДанныеФормы.Вставить("title", "");
	ДанныеФормы.Вставить("elements", Новый Массив);
	ДанныеФормы.Вставить("commands", Новый Массив);
	ДанныеФормы.Вставить("tables", Новый Массив);
	ДанныеФормы.Вставить("metadata", Новый Структура);
	
	// Основная информация о форме
	Попытка
		ДанныеФормы.form_name = Строка(ТестируемаяФорма.ИмяФормы);
	Исключение
		ДанныеФормы.form_name = "";
	КонецПопытки;
	
	Попытка
		ДанныеФормы.title = Строка(ТестируемаяФорма.ТекстЗаголовка);
	Исключение
		ДанныеФормы.title = "";
	КонецПопытки;
	
	ДанныеФормы.form_type = ОпределитьТипФормы(ТестируемаяФорма);
	
	// Метаданные
	ДанныеФормы.metadata.Вставить("collected_at", ТекущаяДатаСеанса());
	ДанныеФормы.metadata.Вставить("collector_version", "1.0.0");
	ДанныеФормы.metadata.Вставить("max_depth", Объект.МаксимальнаяГлубинаВложенности);
	ДанныеФормы.metadata.Вставить("include_invisible", Объект.ВключатьНевидимыеЭлементы);
	
	// Сбор элементов формы
	ТекущаяГлубина = 0;
	СобратьЭлементыФормы(ДанныеФормы.elements);
	
	// Сбор табличных частей (если включено)
	Если Объект.ВключатьТабличныеЧасти Тогда
		СобратьТабличныеЧасти(ДанныеФормы.tables);
	КонецЕсли;
	
	// Сбор команд (если включено)
	Если Объект.ВключатьКоманды Тогда
		СобратьКоманды(ДанныеФормы.commands);
	КонецЕсли;
	
	Возврат ДанныеФормы;
	
КонецФункции

// Определяет тип формы по её имени
//
// Параметры:
//   Форма - ТестируемаяФорма - Форма для анализа
//
// Возвращаемое значение:
//   Строка - Тип формы
//
&НаКлиенте
Функция ОпределитьТипФормы(Форма)
	
	Попытка
		ИмяФормы = Строка(Форма.ИмяФормы);
		
		Если СтрНайти(ИмяФормы, "Документ.") > 0 Тогда
			Возврат "document_form";
		ИначеЕсли СтрНайти(ИмяФормы, "Справочник.") > 0 Тогда
			Возврат "catalog_form";
		ИначеЕсли СтрНайти(ИмяФормы, "Обработка.") > 0 Тогда
			Возврат "data_processor_form";
		ИначеЕсли СтрНайти(ИмяФормы, "Отчет.") > 0 Тогда
			Возврат "report_form";
		ИначеЕсли СтрНайти(ИмяФормы, "РегистрСведений.") > 0 Тогда
			Возврат "information_register_form";
		Иначе
			Возврат "other_form";
		КонецЕсли;
	Исключение
		Возврат "unknown";
	КонецПопытки;
	
КонецФункции

// Рекурсивно собирает элементы формы
//
// Параметры:
//   МассивЭлементов - Массив - Массив для добавления элементов
//   ТекущийРодитель - ТестируемыйЭлементФормы, Неопределено - Родительский элемент
//   Путь - Строка - Текущий путь к элементу
//
&НаКлиенте
Процедура СобратьЭлементыФормы(МассивЭлементов, ТекущийРодитель = Неопределено, Путь = "")
	
	// Проверка ограничения глубины
	ТекущаяГлубина = ТекущаяГлубина + 1;
	Если ТекущаяГлубина > Объект.МаксимальнаяГлубинаВложенности Тогда
		ТекущаяГлубина = ТекущаяГлубина - 1;
		Возврат;
	КонецЕсли;
	
	Попытка
		// Получаем коллекцию элементов
		Если ТекущийРодитель = Неопределено Тогда
			Элементы = ТестируемаяФорма.НайтиОбъекты();
		Иначе
			Элементы = ТекущийРодитель.ПолучитьПодчиненныеОбъекты();
		КонецЕсли;
		
		// Обход всех элементов
		Для Каждого Элемент Из Элементы Цикл
			// Пропуск невидимых элементов (если настройка выключена)
			Если Не Объект.ВключатьНевидимыеЭлементы Тогда
				Попытка
					Если Не Элемент.ТекущаяВидимость() Тогда
						Продолжить;
					КонецЕсли;
				Исключение
					// Игнорируем - у элемента может не быть свойства ТекущаяВидимость
				КонецПопытки;
			КонецЕсли;
			
			// Создаем описание элемента
			ОписаниеЭлемента = СоздатьОписаниеЭлемента(Элемент, Путь);
			МассивЭлементов.Добавить(ОписаниеЭлемента);
			
			// Рекурсивный обход дочерних элементов для групп
			Если ЭлементЯвляетсяГруппой(Элемент) Тогда
				ИмяЭлемента = ПолучитьСвойствоЭлемента(Элемент, "Имя");
				НовыйПуть = ?(ПустаяСтрока(Путь), ИмяЭлемента, Путь + "." + ИмяЭлемента);
				СобратьЭлементыФормы(ОписаниеЭлемента.children, Элемент, НовыйПуть);
			КонецЕсли;
		КонецЦикла;
		
	Исключение
		// Логирование ошибки
		ТекстОшибки = "Ошибка при сборе элементов: " + ОписаниеОшибки();
		СтатусСбора = СтатусСбора + Символы.ПС + ТекстОшибки;
	КонецПопытки;
	
	ТекущаяГлубина = ТекущаяГлубина - 1;
	
КонецПроцедуры

// Создает структуру с описанием элемента формы
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент для описания
//   Путь - Строка - Путь к элементу
//
// Возвращаемое значение:
//   Структура - Описание элемента
//
&НаКлиенте
Функция СоздатьОписаниеЭлемента(Элемент, Путь)
	
	// Создаем структуру для элемента
	Описание = Новый Структура;
	ИмяЭлемента = ПолучитьСвойствоЭлемента(Элемент, "Имя");
	
	Описание.Вставить("name", ИмяЭлемента);
	Описание.Вставить("type", ОпределитьТипЭлемента(Элемент));
	Описание.Вставить("title", ПолучитьЗаголовокЭлемента(Элемент));
	Описание.Вставить("path", ?(ПустаяСтрока(Путь), ИмяЭлемента, Путь + "." + ИмяЭлемента));
	Описание.Вставить("visible", ПолучитьСвойствоВидимость(Элемент));
	Описание.Вставить("enabled", ПолучитьСвойствоДоступность(Элемент));
	Описание.Вставить("data_path", ПолучитьПутьКДанным(Элемент));
	
	// Дополнительные свойства в зависимости от типа
	ДобавитьСпецифичныеСвойства(Элемент, Описание);
	
	// Для групп - массив дочерних элементов
	Если ЭлементЯвляетсяГруппой(Элемент) Тогда
		Описание.Вставить("children", Новый Массив);
	КонецЕсли;
	
	Возврат Описание;
	
КонецФункции

// Определяет тип элемента формы
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент для анализа
//
// Возвращаемое значение:
//   Строка - Тип элемента
//
&НаКлиенте
Функция ОпределитьТипЭлемента(Элемент)
	
	Попытка
		ТипЭлемента = ТипЗнч(Элемент);
		ИмяТипа = Строка(ТипЭлемента);
		
		// Упрощенная типизация
		Если СтрНайти(ИмяТипа, "ПолеВвода") > 0 ИЛИ СтрНайти(ИмяТипа, "ПолеФормы") > 0 Тогда
			Возврат "input_field";
		ИначеЕсли СтрНайти(ИмяТипа, "Кнопка") > 0 Тогда
			Возврат "button";
		ИначеЕсли СтрНайти(ИмяТипа, "ТаблицаФормы") > 0 Тогда
			Возврат "table";
		ИначеЕсли СтрНайти(ИмяТипа, "Группа") > 0 Тогда
			Возврат "group";
		ИначеЕсли СтрНайти(ИмяТипа, "Надпись") > 0 ИЛИ СтрНайти(ИмяТипа, "Декорация") > 0 Тогда
			Возврат "label";
		ИначеЕсли СтрНайти(ИмяТипа, "ПолеФлажка") > 0 ИЛИ СтрНайти(ИмяТипа, "Флажок") > 0 Тогда
			Возврат "checkbox";
		ИначеЕсли СтрНайти(ИмяТипа, "ПолеПереключателя") > 0 ИЛИ СтрНайти(ИмяТипа, "Переключатель") > 0 Тогда
			Возврат "radio_button";
		ИначеЕсли СтрНайти(ИмяТипа, "ПолеКартинки") > 0 Тогда
			Возврат "picture_field";
		Иначе
			Возврат "other";
		КонецЕсли;
	Исключение
		Возврат "unknown";
	КонецПопытки;
	
КонецФункции

// Безопасно получает свойство элемента по имени
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент
//   ИмяСвойства - Строка - Имя свойства
//
// Возвращаемое значение:
//   Строка - Значение свойства или пустая строка
//
&НаКлиенте
Функция ПолучитьСвойствоЭлемента(Элемент, ИмяСвойства)
	
	Попытка
		Возврат Строка(Элемент[ИмяСвойства]);
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Получает заголовок элемента
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент
//
// Возвращаемое значение:
//   Строка - Заголовок элемента
//
&НаКлиенте
Функция ПолучитьЗаголовокЭлемента(Элемент)
	
	Попытка
		Возврат Строка(Элемент.ТекстЗаголовка);
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Получает свойство видимости элемента
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент
//
// Возвращаемое значение:
//   Булево - Видимость элемента
//
&НаКлиенте
Функция ПолучитьСвойствоВидимость(Элемент)
	
	Попытка
		Возврат Элемент.ТекущаяВидимость();
	Исключение
		Возврат Истина;
	КонецПопытки;
	
КонецФункции

// Получает свойство доступности элемента
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент
//
// Возвращаемое значение:
//   Булево - Доступность элемента
//
&НаКлиенте
Функция ПолучитьСвойствоДоступность(Элемент)
	
	Попытка
		Возврат Элемент.ТекущаяДоступность();
	Исключение
		Возврат Истина;
	КонецПопытки;
	
КонецФункции

// Получает путь к данным элемента
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент
//
// Возвращаемое значение:
//   Строка - Путь к данным
//
&НаКлиенте
Функция ПолучитьПутьКДанным(Элемент)
	
	Попытка
		// У TestClient API может не быть прямого доступа к ПутьКДанным
		// Попробуем получить через имя
		Возврат ПолучитьСвойствоЭлемента(Элемент, "Имя");
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Проверяет, является ли элемент группой
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент
//
// Возвращаемое значение:
//   Булево - Истина, если элемент является группой
//
&НаКлиенте
Функция ЭлементЯвляетсяГруппой(Элемент)
	
	Попытка
		// Проверяем наличие метода получения дочерних элементов
		Элемент.ПолучитьПодчиненныеОбъекты();
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Добавляет специфичные свойства элемента в зависимости от типа
//
// Параметры:
//   Элемент - ТестируемыйЭлементФормы - Элемент
//   Описание - Структура - Структура описания элемента
//
&НаКлиенте
Процедура ДобавитьСпецифичныеСвойства(Элемент, Описание)
	
	ТипЭлемента = Описание.type;
	
	Если ТипЭлемента = "input_field" Тогда
		Попытка
			Описание.Вставить("read_only", Элемент.ТекущееТолькоПросмотр());
		Исключение
			// Игнорируем - не все элементы имеют свойство ТолькоПросмотр
		КонецПопытки;
		
		Попытка
			ПодсказкаВвода = ПолучитьСвойствоЭлемента(Элемент, "ПодсказкаВвода");
			Если Не ПустаяСтрока(ПодсказкаВвода) Тогда
				Описание.Вставить("input_hint", ПодсказкаВвода);
			КонецЕсли;
		Исключение
			// Игнорируем - не все элементы имеют свойство ПодсказкаВвода
		КонецПопытки;
		
	ИначеЕсли ТипЭлемента = "button" Тогда
		Попытка
			ИмяКоманды = ПолучитьСвойствоЭлемента(Элемент, "ИмяКоманды");
			Если Не ПустаяСтрока(ИмяКоманды) Тогда
				Описание.Вставить("command", ИмяКоманды);
			КонецЕсли;
		Исключение
			// Игнорируем - не все элементы имеют свойство ИмяКоманды
		КонецПопытки;
		
	ИначеЕсли ТипЭлемента = "table" Тогда
		Попытка
			РежимВыделения = ПолучитьСвойствоЭлемента(Элемент, "РежимВыделения");
			Если Не ПустаяСтрока(РежимВыделения) Тогда
				Описание.Вставить("selection_mode", РежимВыделения);
			КонецЕсли;
		Исключение
			// Игнорируем - не все элементы имеют свойство РежимВыделения
		КонецПопытки;
		
		Попытка
			АвтоДобавление = ПолучитьСвойствоЭлемента(Элемент, "АвтоДобавлениеПриВводе");
			Если Не ПустаяСтрока(АвтоДобавление) Тогда
				Описание.Вставить("auto_add", АвтоДобавление = "Истина");
			КонецЕсли;
		Исключение
			// Игнорируем - не все элементы имеют свойство АвтоДобавлениеПриВводе
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры

// Собирает информацию о табличных частях формы (минимальная реализация для этапа 1)
//
// Параметры:
//   МассивТаблиц - Массив - Массив для добавления информации о таблицах
//
&НаКлиенте
Процедура СобратьТабличныеЧасти(МассивТаблиц)
	
	// TODO: Полная реализация будет на этапе 2
	// Для этапа 1 - минимальный функционал
	
	Попытка
		Элементы = ТестируемаяФорма.НайтиОбъекты();
		
		Для Каждого Элемент Из Элементы Цикл
			Если ОпределитьТипЭлемента(Элемент) = "table" Тогда
				ОписаниеТаблицы = Новый Структура;
				ОписаниеТаблицы.Вставить("name", ПолучитьСвойствоЭлемента(Элемент, "Имя"));
				ОписаниеТаблицы.Вставить("title", ПолучитьЗаголовокЭлемента(Элемент));
				ОписаниеТаблицы.Вставить("data_path", ПолучитьПутьКДанным(Элемент));
				
				МассивТаблиц.Добавить(ОписаниеТаблицы);
			КонецЕсли;
		КонецЦикла;
		
	Исключение
		// Игнорируем ошибки на этапе 1 - детальная обработка будет на этапе 2
	КонецПопытки;
	
КонецПроцедуры

// Собирает информацию о командах формы (заглушка для этапа 1)
//
// Параметры:
//   МассивКоманд - Массив - Массив для добавления информации о командах
//
&НаКлиенте
Процедура СобратьКоманды(МассивКоманд)
	
	// TODO: Полная реализация будет на этапе 2
	// Для этапа 1 - пропускаем сбор команд
	Возврат;
	
КонецПроцедуры

// Преобразует структуру данных в JSON
//
// Параметры:
//   Данные - Структура - Данные для преобразования
//
// Возвращаемое значение:
//   Строка - JSON-строка
//
&НаКлиенте
Функция ПреобразоватьВJSON(Данные)
	
	Попытка
		// Используем встроенный сериализатор JSON
		// Для клиентской стороны нужно вызвать серверную функцию
		Возврат ПреобразоватьВJSONНаСервере(Данные);
	Исключение
		ВызватьИсключение "Ошибка при преобразовании в JSON: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

// Преобразует структуру данных в JSON (серверная часть)
//
// Параметры:
//   Данные - Структура - Данные для преобразования
//
// Возвращаемое значение:
//   Строка - JSON-строка
//
&НаСервере
Функция ПреобразоватьВJSONНаСервере(Данные)
	
	Попытка
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(, Символы.Таб));
		ЗаписатьJSON(ЗаписьJSON, Данные);
		
		Возврат ЗаписьJSON.Закрыть();
	Исключение
		ВызватьИсключение "Ошибка при преобразовании в JSON: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

// Сохраняет JSON в файл
//
// Параметры:
//   ТекстJSON - Строка - JSON для сохранения
//
&НаКлиенте
Процедура СохранитьВФайл(ТекстJSON)
	
	Попытка
		// Для сохранения файла на клиенте используем серверную функцию
		СохранитьВФайлНаСервере(ТекстJSON, Объект.ПутьКФайлуВыгрузки);
	Исключение
		ВызватьИсключение "Ошибка при сохранении файла: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецПроцедуры

// Сохраняет JSON в файл (серверная часть)
//
// Параметры:
//   ТекстJSON - Строка - JSON для сохранения
//   ПутьКФайлу - Строка - Путь к файлу
//
&НаСервере
Процедура СохранитьВФайлНаСервере(ТекстJSON, ПутьКФайлу)
	
	Попытка
		ЗаписьТекста = Новый ЗаписьТекста(ПутьКФайлу, КодировкаТекста.UTF8);
		ЗаписьТекста.Записать(ТекстJSON);
		ЗаписьТекста.Закрыть();
	Исключение
		ВызватьИсключение "Ошибка при сохранении файла: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти


