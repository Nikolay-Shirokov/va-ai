////////////////////////////////////////////////////////////////////////////////
// Form Context Collector - Автономная версия
// Версия: 1.0.0
//
// Сбор контекста форм 1С без зависимости от Vanessa Automation
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Лог("=== Запуск обработки Form Context Collector ===");
	Лог("Версия: 1.0.0");
	
	// Проверка режима запуска (агентский/интерактивный)
	РежимРаботы = ПроверитьРежимЗапуска();
	Лог("Определён режим работы: " + РежимРаботы);
	
	Если РежимРаботы = "agent" Тогда
		// Агентский режим - автоматическое выполнение
		Лог("Переход в агентский режим");
		ВыполнитьАгентскийРежим();
	Иначе
		// Интерактивный режим - обновляем список форм
		Лог("Переход в интерактивный режим");
		ОбновитьСписокФорм();
	КонецЕсли;
	
	Лог("Инициализация завершена");
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Очищаем лог при каждом открытии
	Если Объект.РежимОтладки Тогда
		ОчиститьЛог();
	КонецЕсли;
	
	// Установка значений по умолчанию
	Объект.ВключатьНевидимыеЭлементы = Ложь;
	Объект.ГенерироватьMarkdown = Истина;
	Объект.МаксимальнаяГлубинаВложенности = 5;
	Объект.РежимОтладки = Ложь;
	
	// Определяем путь сохранения
	Объект.ПутьСохранения = ПолучитьПутьКонтекста();
	
	СтатусСбора = "Готов к работе";
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ПутьСохраненияНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	Диалог.Заголовок = "Выберите каталог для сохранения результатов";
	Диалог.Каталог = Объект.ПутьСохранения;
	
	Если Диалог.Выбрать() Тогда
		Объект.ПутьСохранения = Диалог.Каталог;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОбновитьСписокФорм(Команда = Неопределено)
	Лог("--- Обновление списка форм ---");
	СписокФорм.Очистить();
	СтатусСбора = "Обновление списка форм...";
	
	Попытка
		// Получаем список открытых форм
		Лог("Вызов ПолучитьСписокОткрытыхФорм()");
		МассивФорм = ПолучитьСписокОткрытыхФорм();
		Лог("Получено форм: " + Формат(МассивФорм.Количество(), "ЧГ="));
		
		// Заполняем таблицу
		Для Каждого ИнфоФормы Из МассивФорм Цикл
			НоваяСтрока = СписокФорм.Добавить();
			НоваяСтрока.Выбрано = Истина;
			НоваяСтрока.Заголовок = ИнфоФормы.Заголовок;
			НоваяСтрока.ПолноеИмяФормы = ИнфоФормы.ИмяФормы;
			НоваяСтрока.ВидОбъекта = ИнфоФормы.ВидОбъекта;
			НоваяСтрока.ТипФормы = ИнфоФормы.ТипФормы;
			НоваяСтрока.УИДФормы = ИнфоФормы.УИДФормы;
			
			Лог("  + " + ИнфоФормы.ИмяФормы + " (" + ИнфоФормы.Заголовок + "), УИД: " + ИнфоФормы.УИДФормы, "DEBUG");
		КонецЦикла;
		
		СтатусСбора = "Найдено форм: " + Формат(МассивФорм.Количество(), "ЧГ=");
		Лог("Обновление списка завершено успешно");
		
	Исключение
		СтатусСбора = "Ошибка получения списка форм: " + ОписаниеОшибки();
		Лог("ОШИБКА при обновлении списка: " + ОписаниеОшибки(), "ERROR");
		Лог("Подробно: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "ERROR");
	КонецПопытки;
КонецПроцедуры

&НаКлиенте
Процедура СобратьКонтекст(Команда)
	Лог("=== Начало сбора контекста ===");
	СтатусСбора = "Выполняется сбор контекста...";
	РезультатСбора = "";
	
	Попытка
		// Получаем отмеченные формы
		ВыбранныеФормы = Новый Массив;
		Для Каждого Строка Из СписокФорм Цикл
			Если Строка.Выбрано Тогда
				ВыбранныеФормы.Добавить(Строка);
			КонецЕсли;
		КонецЦикла;
		
		Лог("Выбрано форм для обработки: " + Формат(ВыбранныеФормы.Количество(), "ЧГ="));
		
		Если ВыбранныеФормы.Количество() = 0 Тогда
			СтатусСбора = "Не выбрано ни одной формы";
			Лог("Прервано: не выбрано форм", "ERROR");
			Возврат;
		КонецЕсли;
		
		// Собираем контекст для каждой формы
		КоличествоУспешных = 0;
		КоличествоОшибок = 0;
		
		Для Каждого ВыбраннаяФорма Из ВыбранныеФормы Цикл
			Попытка
				Лог("--- Обработка формы: " + ВыбраннаяФорма.ПолноеИмяФормы);
				
				// Ищем форму по УИД среди открытых форм
				Лог("  Поиск формы по УИД: " + ВыбраннаяФорма.УИДФормы);
				СсылкаНаФорму = НайтиФормуПоУИД(ВыбраннаяФорма.УИДФормы);
				Если СсылкаНаФорму = Неопределено Тогда
					ВызватьИсключение "Форма с УИД " + ВыбраннаяФорма.УИДФормы + " не найдена или была закрыта";
				КонецЕсли;
				
				// Сбор данных формы
				Лог("  Сбор информации о форме...");
				ДанныеФормы = СобратьИнформациюОФорме(СсылкаНаФорму);
				Лог("  Собрано элементов: " + Формат(ДанныеФормы.elements.Количество(), "ЧГ="));
				
				// Генерация JSON
				Лог("  Генерация JSON...");
				ТекстJSON = ПреобразоватьВJSON(ДанныеФормы);
				
				// Сохранение JSON
				ИмяФайлаJSON = СформироватьИмяФайла(ДанныеФормы.form_name) + ".json";
				ПутьJSON = Объект.ПутьСохранения + ИмяФайлаJSON;
				Лог("  Сохранение JSON: " + ПутьJSON);
				СохранитьВФайл(ТекстJSON, ПутьJSON);
				
				// Генерация Markdown (если включено)
				Если Объект.ГенерироватьMarkdown Тогда
					Лог("  Генерация Markdown...");
					ТекстMarkdown = СгенерироватьMarkdown(ДанныеФормы);
					ИмяФайлаMD = СформироватьИмяФайла(ДанныеФормы.form_name) + ".md";
					ПутьMD = Объект.ПутьСохранения + ИмяФайлаMD;
					Лог("  Сохранение Markdown: " + ПутьMD);
					СохранитьВФайл(ТекстMarkdown, ПутьMD);
				КонецЕсли;
				
				// Обновление индекса
				Лог("  Обновление index.json...");
				ОбновитьИндексФорм(ДанныеФормы, ИмяФайлаJSON);
				
				КоличествоУспешных = КоличествоУспешных + 1;
				РезультатСбора = РезультатСбора + "✓ " + ДанныеФормы.form_name + Символы.ПС;
				Лог("  ✓ Форма обработана успешно");
				
			Исключение
				КоличествоОшибок = КоличествоОшибок + 1;
				ТекстОшибки = ОписаниеОшибки();
				РезультатСбора = РезультатСбора + "✗ " + ВыбраннаяФорма.ПолноеИмяФормы +
					": " + ТекстОшибки + Символы.ПС;
				Лог("  ✗ ОШИБКА: " + ТекстОшибки, "ERROR");
				Лог("  Подробно: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "ERROR");
			КонецПопытки;
		КонецЦикла;
		
		СтатусСбора = СтрШаблон("Сбор завершен. Успешно: %1, Ошибок: %2",
			КоличествоУспешных, КоличествоОшибок);
		Лог("=== Сбор контекста завершён. Успешно: " + Формат(КоличествоУспешных, "ЧГ=") +
			", Ошибок: " + Формат(КоличествоОшибок, "ЧГ=") + " ===");
		
	Исключение
		СтатусСбора = "Ошибка сбора контекста: " + ОписаниеОшибки();
		РезультатСбора = РезультатСбора + Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		Лог("КРИТИЧЕСКАЯ ОШИБКА при сборе контекста: " + ОписаниеОшибки(), "ERROR");
		Лог("Стек: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "ERROR");
	КонецПопытки;
КонецПроцедуры

&НаКлиенте
Процедура Очистить(Команда)
	РезультатСбора = "";
	СтатусСбора = "Готов к работе";
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область РаботаСФормами

// Получает список открытых форм в приложении
//
// Возвращаемое значение:
//   Массив из Структура - Массив с информацией о формах
//
&НаКлиенте
Функция ПолучитьСписокОткрытыхФорм()
	МассивНайденныхФорм = Новый Массив;
	
	// Получаем УИД текущей формы, чтобы исключить её из списка
	УИДТекущейФормы = Строка(ЭтаФорма.УникальныйИдентификатор);
	Лог("  УИД текущей формы: " + УИДТекущейФормы, "DEBUG");
	
	// Получаем все окна приложения
	КоллекцияОкон = ПолучитьОкна();
	
	Если КоллекцияОкон = Неопределено Тогда
		Возврат МассивНайденныхФорм;
	КонецЕсли;
	
	// Обходим все окна
	Для Каждого ТекущееОкно Из КоллекцияОкон Цикл
		Попытка
			// Получаем формы в окне
			МассивФормОкна = ТекущееОкно.Содержимое;
			
			Для Каждого ТекущаяФорма Из МассивФормОкна Цикл
				Попытка
					// Получаем встроенный УникальныйИдентификатор формы
					УИДФормы = Строка(ТекущаяФорма.УникальныйИдентификатор);
					
					ИнфоФормы = Новый Структура;
					ИнфоФормы.Вставить("Заголовок", ПолучитьЗаголовокФормы(ТекущаяФорма));
					ИнфоФормы.Вставить("ИмяФормы", ПолучитьПолноеИмяФормы(ТекущаяФорма));
					ИнфоФормы.Вставить("ВидОбъекта", ПолучитьВидОбъекта(ТекущаяФорма));
					ИнфоФормы.Вставить("ТипФормы", ПолучитьТипФормы(ТекущаяФорма));
					ИнфоФормы.Вставить("УИДФормы", УИДФормы);
					
					// Пропускаем текущую форму обработки по УИД
					Если УИДФормы = УИДТекущейФормы Тогда
						Лог("  Пропущена текущая форма обработки (УИД: " + УИДФормы + ")", "DEBUG");
						Продолжить;
					КонецЕсли;
					
					МассивНайденныхФорм.Добавить(ИнфоФормы);
				Исключение
					Лог("  Пропущена форма из-за ошибки: " + ОписаниеОшибки(), "DEBUG");
				КонецПопытки;
			КонецЦикла;
		Исключение
			Лог("  Пропущено окно из-за ошибки: " + ОписаниеОшибки(), "DEBUG");
		КонецПопытки;
	КонецЦикла;
	
	Возврат МассивНайденныхФорм;
КонецФункции

// Получает заголовок формы
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма
//
// Возвращаемое значение:
//   Строка - Заголовок формы
//
&НаКлиенте
Функция ПолучитьЗаголовокФормы(Форма)
	Попытка
		ЗаголовокФормы = "";
		
		// Способ 1: через свойство Заголовок
		Попытка
			ЗаголовокФормы = Строка(Форма.Заголовок);
		Исключение
			Лог("    Не удалось получить Форма.Заголовок: " + ОписаниеОшибки(), "DEBUG");
		КонецПопытки;
		
		// Способ 2: через преобразование формы в строку
		Если ПустаяСтрока(ЗаголовокФормы) Тогда
			Попытка
				ЗаголовокФормы = Строка(Форма);
			Исключение
				Лог("    Не удалось получить Строка(Форма): " + ОписаниеОшибки(), "DEBUG");
			КонецПопытки;
		КонецЕсли;
		
		Если ПустаяСтрока(ЗаголовокФормы) Тогда
			Возврат "Без заголовка";
		Иначе
			Возврат ЗаголовокФормы;
		КонецЕсли;
	Исключение
		Лог("    Критическая ошибка получения заголовка: " + ОписаниеОшибки(), "ERROR");
		Возврат "Без заголовка";
	КонецПопытки;
КонецФункции

// Получает полное имя формы
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма
//
// Возвращаемое значение:
//   Строка - Полное имя формы
//
&НаКлиенте
Функция ПолучитьПолноеИмяФормы(Форма)
	ПолноеИмя = "";
	
	// Способ 1: через свойство ИмяФормы (основной способ)
	Попытка
		ПолноеИмя = Форма.ИмяФормы;
		Если Не ПустаяСтрока(ПолноеИмя) Тогда
			Возврат ПолноеИмя;
		КонецЕсли;
	Исключение
		Лог("    Не удалось получить Форма.ИмяФормы: " + ОписаниеОшибки(), "DEBUG");
	КонецПопытки;
	
	// Способ 2: через ИмяМетаданных
	Попытка
		ПолноеИмя = Форма.ИмяМетаданных;
		Если Не ПустаяСтрока(ПолноеИмя) Тогда
			Возврат ПолноеИмя;
		КонецЕсли;
	Исключение
		Лог("    Не удалось получить Форма.ИмяМетаданных: " + ОписаниеОшибки(), "DEBUG");
	КонецПопытки;
	
	// Способ 3: через ИмяОбъектаМетаданных
	Попытка
		ПолноеИмя = Форма.ИмяОбъектаМетаданных;
		Если Не ПустаяСтрока(ПолноеИмя) Тогда
			Возврат ПолноеИмя;
		КонецЕсли;
	Исключение
		Лог("    Не удалось получить Форма.ИмяОбъектаМетаданных: " + ОписаниеОшибки(), "DEBUG");
	КонецПопытки;
	
	// Если не удалось получить имя, возвращаем заголовок
	Лог("    Не удалось получить имя формы ни одним способом, используем заголовок", "DEBUG");
	Возврат ПолучитьЗаголовокФормы(Форма);
КонецФункции

// Определяет вид объекта по имени формы
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма
//
// Возвращаемое значение:
//   Строка - Вид объекта (Документ, Справочник и т.д.)
//
&НаКлиенте
Функция ПолучитьВидОбъекта(Форма)
	Попытка
		ИмяФормы = Строка(Форма.ИмяФормы);
		
		Если СтрНайти(ИмяФормы, "Документ.") = 1 Тогда
			Возврат "Документ";
		ИначеЕсли СтрНайти(ИмяФормы, "Справочник.") = 1 Тогда
			Возврат "Справочник";
		ИначеЕсли СтрНайти(ИмяФормы, "Отчет.") = 1 Тогда
			Возврат "Отчет";
		ИначеЕсли СтрНайти(ИмяФормы, "Обработка.") = 1 Тогда
			Возврат "Обработка";
		ИначеЕсли СтрНайти(ИмяФормы, "РегистрСведений.") = 1 Тогда
			Возврат "РегистрСведений";
		ИначеЕсли СтрНайти(ИмяФормы, "РегистрНакопления.") = 1 Тогда
			Возврат "РегистрНакопления";
		ИначеЕсли СтрНайти(ИмяФормы, "ОбщаяФорма.") = 1 Тогда
			Возврат "ОбщаяФорма";
		КонецЕсли;
	Исключение
		// Игнорируем - функция вернет "Прочее" по умолчанию
	КонецПопытки;
	
	Возврат "Прочее";
КонецФункции

// Ищет форму по УникальномуИдентификатору среди открытых форм
//
// Параметры:
//   УИДФормы - Строка - УникальныйИдентификатор формы
//
// Возвращаемое значение:
//   ФормаКлиентскогоПриложения, Неопределено - Найденная форма или Неопределено
//
&НаКлиенте
Функция НайтиФормуПоУИД(УИДФормы)
	// Получаем все окна приложения
	КоллекцияОкон = ПолучитьОкна();
	
	Если КоллекцияОкон = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Обходим все окна
	Для Каждого ТекущееОкно Из КоллекцияОкон Цикл
		Попытка
			// Получаем формы в окне
			МассивФормОкна = ТекущееОкно.Содержимое;
			
			Для Каждого ТекущаяФорма Из МассивФормОкна Цикл
				Попытка
					// Проверяем совпадение УИД
					Если Строка(ТекущаяФорма.УникальныйИдентификатор) = УИДФормы Тогда
						Возврат ТекущаяФорма;
					КонецЕсли;
				Исключение
					Лог("  Ошибка при проверке УИД формы: " + ОписаниеОшибки(), "DEBUG");
				КонецПопытки;
			КонецЦикла;
		Исключение
			Лог("  Ошибка при обработке окна: " + ОписаниеОшибки(), "DEBUG");
		КонецПопытки;
	КонецЦикла;
	
	Возврат Неопределено;
КонецФункции

// Определяет тип формы по её имени
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма
//
// Возвращаемое значение:
//   Строка - Тип формы (ФормаДокумента, ФормаСписка и т.д.)
//
&НаКлиенте
Функция ПолучитьТипФормы(Форма)
	Попытка
		ИмяФормы = Строка(Форма.ИмяФормы);
		
		// Извлекаем последнюю часть после последней точки
		МассивЧастей = СтрРазделить(ИмяФормы, ".", Ложь);
		Если МассивЧастей.Количество() > 0 Тогда
			ТипФормы = МассивЧастей[МассивЧастей.Количество() - 1];
			Возврат ТипФормы;
		КонецЕсли;
	Исключение
		// Игнорируем - функция вернет "ПроизвольнаяФорма" по умолчанию
	КонецПопытки;
	
	Возврат "ПроизвольнаяФорма";
КонецФункции

#КонецОбласти

#Область СборКонтекста

// Собирает информацию о форме и её элементах
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма для сбора контекста
//
// Возвращаемое значение:
//   Структура - Данные о форме
//
&НаКлиенте
Функция СобратьИнформациюОФорме(Форма)
	// Создаем структуру для хранения данных
	ДанныеФормы = Новый Структура;
	ДанныеФормы.Вставить("form_name", ПолучитьПолноеИмяФормы(Форма));
	ДанныеФормы.Вставить("form_type", ОпределитьТипФормыПоИмени(ДанныеФормы.form_name));
	ДанныеФормы.Вставить("title", ПолучитьЗаголовокФормы(Форма));
	ДанныеФормы.Вставить("elements", Новый Массив);
	
	// Метаданные
	Метаданные = Новый Структура;
	Метаданные.Вставить("collected_at", ТекущаяДата()); // Клиентский контекст - используем ТекущаяДата()
	Метаданные.Вставить("collector_version", "1.0.0");
	Метаданные.Вставить("max_depth", Объект.МаксимальнаяГлубинаВложенности);
	Метаданные.Вставить("include_invisible", Объект.ВключатьНевидимыеЭлементы);
	Метаданные.Вставить("detail_level", "minimal");
	ДанныеФормы.Вставить("metadata", Метаданные);
	
	// Сбор элементов формы
	СобратьЭлементыФормы(Форма, ДанныеФормы.elements, 0);
	
	Возврат ДанныеФормы;
КонецФункции

// Определяет тип формы по её имени для JSON
//
// Параметры:
//   ИмяФормы - Строка - Полное имя формы
//
// Возвращаемое значение:
//   Строка - Тип формы на английском
//
&НаКлиенте
Функция ОпределитьТипФормыПоИмени(ИмяФормы)
	Если СтрНайти(ИмяФормы, "Документ.") > 0 Тогда
		Возврат "document_form";
	ИначеЕсли СтрНайти(ИмяФормы, "Справочник.") > 0 Тогда
		Возврат "catalog_form";
	ИначеЕсли СтрНайти(ИмяФормы, "Обработка.") > 0 Тогда
		Возврат "data_processor_form";
	ИначеЕсли СтрНайти(ИмяФормы, "Отчет.") > 0 Тогда
		Возврат "report_form";
	ИначеЕсли СтрНайти(ИмяФормы, "РегистрСведений.") > 0 Тогда
		Возврат "information_register_form";
	Иначе
		Возврат "other_form";
	КонецЕсли;
КонецФункции

// Собирает элементы формы
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма
//   МассивЭлементов - Массив - Массив для добавления элементов
//   ТекущаяГлубина - Число - Текущая глубина рекурсии
//
&НаКлиенте
Процедура СобратьЭлементыФормы(Форма, МассивЭлементов, ТекущаяГлубина)
	// Проверка ограничения глубины
	Если ТекущаяГлубина >= Объект.МаксимальнаяГлубинаВложенности Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		// Получаем элементы формы
		ЭлементыФормы = Форма.ЭлементыФормы;
		
		Для Каждого Элемент Из ЭлементыФормы Цикл
			Попытка
				// Проверка видимости
				Если Не Объект.ВключатьНевидимыеЭлементы Тогда
					Если Не Элемент.Видимость Тогда
						Продолжить;
					КонецЕсли;
				КонецЕсли;
				
				// Создаем описание элемента
				ОписаниеЭлемента = СоздатьОписаниеЭлемента(Элемент);
				МассивЭлементов.Добавить(ОписаниеЭлемента);
				
			Исключение
				Лог("  Пропущен элемент из-за ошибки: " + ОписаниеОшибки(), "DEBUG");
			КонецПопытки;
		КонецЦикла;
		
	Исключение
		Лог("  Ошибка при получении элементов формы: " + ОписаниеОшибки(), "DEBUG");
	КонецПопытки;
КонецПроцедуры

// Создает описание элемента формы
//
// Параметры:
//   Элемент - ЭлементФормы - Элемент формы
//
// Возвращаемое значение:
//   Структура - Описание элемента
//
&НаКлиенте
Функция СоздатьОписаниеЭлемента(Элемент)
	Описание = Новый Структура;
	
	// Основные свойства
	Описание.Вставить("name", ПолучитьСвойствоЭлемента(Элемент, "Имя"));
	Описание.Вставить("type", ОпределитьТипЭлемента(Элемент));
	Описание.Вставить("title", ПолучитьСвойствоЭлемента(Элемент, "Заголовок"));
	Описание.Вставить("visible", ПолучитьСвойствоЭлемента(Элемент, "Видимость"));
	Описание.Вставить("enabled", ПолучитьСвойствоЭлемента(Элемент, "Доступность"));
	
	// Путь к данным
	ПутьКДанным = ПолучитьСвойствоЭлемента(Элемент, "ПутьКДанным");
	Если Не ПустаяСтрока(ПутьКДанным) Тогда
		Описание.Вставить("data_path", ПутьКДанным);
	КонецЕсли;
	
	Возврат Описание;
КонецФункции

// Определяет тип элемента формы
//
// Параметры:
//   Элемент - ЭлементФормы - Элемент для анализа
//
// Возвращаемое значение:
//   Строка - Тип элемента
//
&НаКлиенте
Функция ОпределитьТипЭлемента(Элемент)
	Попытка
		ТипЭлемента = ТипЗнч(Элемент);
		ИмяТипа = Строка(ТипЭлемента);
		
		Если СтрНайти(ИмяТипа, "ПолеФормы") > 0 Тогда
			Возврат "input_field";
		ИначеЕсли СтрНайти(ИмяТипа, "Кнопка") > 0 Тогда
			Возврат "button";
		ИначеЕсли СтрНайти(ИмяТипа, "ТаблицаФормы") > 0 Тогда
			Возврат "table";
		ИначеЕсли СтрНайти(ИмяТипа, "ГруппаФормы") > 0 Тогда
			Возврат "group";
		ИначеЕсли СтрНайти(ИмяТипа, "Надпись") > 0 ИЛИ СтрНайти(ИмяТипа, "Декорация") > 0 Тогда
			Возврат "label";
		Иначе
			Возврат "other";
		КонецЕсли;
	Исключение
		Возврат "unknown";
	КонецПопытки;
КонецФункции

// Безопасно получает свойство элемента
//
// Параметры:
//   Элемент - ЭлементФормы - Элемент
//   ИмяСвойства - Строка - Имя свойства
//
// Возвращаемое значение:
//   Произвольный - Значение свойства
//
&НаКлиенте
Функция ПолучитьСвойствоЭлемента(Элемент, ИмяСвойства)
	Попытка
		Возврат Элемент[ИмяСвойства];
	Исключение
		Возврат "";
	КонецПопытки;
КонецФункции

#КонецОбласти

#Область ГенерацияВыходныхФайлов

// Генерирует Markdown документацию по форме
//
// Параметры:
//   ДанныеФормы - Структура - Данные формы
//
// Возвращаемое значение:
//   Строка - Markdown текст
//
&НаСервере
Функция СгенерироватьMarkdown(ДанныеФормы)
	Результат = "";
	
	// Заголовок
	Результат = Результат + "# Форма: " + ДанныеФормы.title + Символы.ПС + Символы.ПС;
	Результат = Результат + "**Полное имя:** `" + ДанныеФормы.form_name + "`" + Символы.ПС;
	Результат = Результат + "**Тип:** " + ДанныеФормы.form_type + Символы.ПС;
	Результат = Результат + "**Собрано:** " + Формат(ДанныеФормы.metadata.collected_at, "ДФ='dd.MM.yyyy HH:mm'") + Символы.ПС + Символы.ПС;
	Результат = Результат + "---" + Символы.ПС + Символы.ПС;
	
	// Группировка элементов по типам
	ПоляВвода = Новый Массив;
	Кнопки = Новый Массив;
	Таблицы = Новый Массив;
	Группы = Новый Массив;
	Прочие = Новый Массив;
	
	Для Каждого Элемент Из ДанныеФормы.elements Цикл
		Если Элемент.type = "input_field" Тогда
			ПоляВвода.Добавить(Элемент);
		ИначеЕсли Элемент.type = "button" Тогда
			Кнопки.Добавить(Элемент);
		ИначеЕсли Элемент.type = "table" Тогда
			Таблицы.Добавить(Элемент);
		ИначеЕсли Элемент.type = "group" Тогда
			Группы.Добавить(Элемент);
		Иначе
			Прочие.Добавить(Элемент);
		КонецЕсли;
	КонецЦикла;
	
	// Поля ввода
	Если ПоляВвода.Количество() > 0 Тогда
		Результат = Результат + "## 📝 Поля формы" + Символы.ПС + Символы.ПС;
		Для Каждого Поле Из ПоляВвода Цикл
			Результат = Результат + "- `" + Поле.name + "`";
			Если Не ПустаяСтрока(Поле.title) И Поле.title <> Поле.name Тогда
				Результат = Результат + " - " + Поле.title;
			КонецЕсли;
			Результат = Результат + Символы.ПС;
		КонецЦикла;
		Результат = Результат + Символы.ПС;
	КонецЕсли;
	
	// Таблицы
	Если Таблицы.Количество() > 0 Тогда
		Результат = Результат + "## 📊 Табличные части" + Символы.ПС + Символы.ПС;
		Для Каждого Таблица Из Таблицы Цикл
			Результат = Результат + "### " + Таблица.name;
			Если Не ПустаяСтрока(Таблица.title) Тогда
				Результат = Результат + " - " + Таблица.title;
			КонецЕсли;
			Результат = Результат + Символы.ПС + Символы.ПС;
		КонецЦикла;
	КонецЕсли;
	
	// Кнопки
	Если Кнопки.Количество() > 0 Тогда
		Результат = Результат + "## 🔘 Команды" + Символы.ПС + Символы.ПС;
		Для Каждого Кнопка Из Кнопки Цикл
			Результат = Результат + "- `" + Кнопка.name + "`";
			Если Не ПустаяСтрока(Кнопка.title) Тогда
				Результат = Результат + " - " + Кнопка.title;
			КонецЕсли;
			Результат = Результат + Символы.ПС;
		КонецЦикла;
		Результат = Результат + Символы.ПС;
	КонецЕсли;
	
	// Статистика
	Результат = Результат + "---" + Символы.ПС + Символы.ПС;
	Результат = Результат + "**Всего элементов:** " + Формат(ДанныеФормы.elements.Количество(), "ЧГ=") + Символы.ПС;
	
	Возврат Результат;
КонецФункции

// Формирует имя файла на основе полного имени формы
//
// Параметры:
//   ПолноеИмяФормы - Строка - Полное имя формы
//
// Возвращаемое значение:
//   Строка - Имя файла без расширения
//
&НаСервере
Функция СформироватьИмяФайла(ПолноеИмяФормы)
	// Заменяем разделители на точки
	ИмяФайла = СтрЗаменить(ПолноеИмяФормы, "/", ".");
	ИмяФайла = СтрЗаменить(ИмяФайла, "\", ".");
	
	Возврат ИмяФайла;
КонецФункции

#КонецОбласти

#Область РаботаСФайлами

// Получает путь к каталогу для сохранения контекста
//
// Возвращаемое значение:
//   Строка - Путь к каталогу context/forms/
//
&НаСервере
Функция ПолучитьПутьКонтекста()
	// Получаем путь к файлу обработки через экспортную функцию объекта
	ПутьКОбработке = РеквизитФормыВЗначение("Объект").ПолучитьПутьКФайлуОбработки();
	
	// Извлекаем директорию обработки
	ФайлОбработки = Новый Файл(ПутьКОбработке);
	КаталогОбработки = ФайлОбработки.Путь;
	
	// Поднимаемся на 1 уровень вверх: tools/form-context/ -> tools/
	ФайлКаталогаОбработки = Новый Файл(КаталогОбработки);
	КаталогTools = ФайлКаталогаОбработки.Путь;
	
	// Поднимаемся еще на 1 уровень вверх: tools/ -> корень проекта
	ФайлКаталогаTools = Новый Файл(КаталогTools);
	КорневойКаталог = ФайлКаталогаTools.Путь;
	
	// Формируем путь к context/forms/
	ПутьКонтекста = КорневойКаталог + "context" + ПолучитьРазделительПути() + "forms" + ПолучитьРазделительПути();
	
	// Создаем директорию если не существует
	ФайлКаталога = Новый Файл(ПутьКонтекста);
	Если Не ФайлКаталога.Существует() Тогда
		СоздатьКаталог(ПутьКонтекста);
	КонецЕсли;
	
	Возврат ПутьКонтекста;
КонецФункции

// Преобразует структуру данных в JSON
//
// Параметры:
//   Данные - Структура - Данные для преобразования
//
// Возвращаемое значение:
//   Строка - JSON строка
//
&НаКлиенте
Функция ПреобразоватьВJSON(Данные)
	Возврат ПреобразоватьВJSONНаСервере(Данные);
КонецФункции

// Преобразует структуру данных в JSON (серверная часть)
//
// Параметры:
//   Данные - Структура - Данные для преобразования
//
// Возвращаемое значение:
//   Строка - JSON строка
//
&НаСервере
Функция ПреобразоватьВJSONНаСервере(Данные)
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(, Символы.Таб));
	ЗаписатьJSON(ЗаписьJSON, Данные);
	
	Возврат ЗаписьJSON.Закрыть();
КонецФункции

// Сохраняет текст в файл
//
// Параметры:
//   Текст - Строка - Текст для сохранения
//   ПутьКФайлу - Строка - Полный путь к файлу
//
&НаКлиенте
Процедура СохранитьВФайл(Текст, ПутьКФайлу)
	СохранитьВФайлНаСервере(Текст, ПутьКФайлу);
КонецПроцедуры

// Сохраняет текст в файл (серверная часть)
//
// Параметры:
//   Текст - Строка - Текст для сохранения
//   ПутьКФайлу - Строка - Полный путь к файлу
//
&НаСервере
Процедура СохранитьВФайлНаСервере(Текст, ПутьКФайлу)
	ЗаписьТекста = Новый ЗаписьТекста(ПутьКФайлу, КодировкаТекста.UTF8);
	ЗаписьТекста.Записать(Текст);
	ЗаписьТекста.Закрыть();
КонецПроцедуры

// Обновляет индексный файл со списком всех форм
//
// Параметры:
//   ДанныеФормы - Структура - Данные формы
//   ИмяФайлаJSON - Строка - Имя JSON файла
//
&НаСервере
Процедура ОбновитьИндексФорм(ДанныеФормы, ИмяФайлаJSON)
	ПутьИндекса = Объект.ПутьСохранения + "index.json";
	
	// Читаем существующий индекс
	ФайлИндекса = Новый Файл(ПутьИндекса);
	
	Если ФайлИндекса.Существует() Тогда
		ЧтениеТекста = Новый ЧтениеТекста(ПутьИндекса, КодировкаТекста.UTF8);
		ТекстJSON = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТекстJSON);
		Индекс = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
	Иначе
		Индекс = Новый Структура;
		Индекс.Вставить("version", "1.0");
		Индекс.Вставить("forms", Новый Структура);
	КонецЕсли;
	
	// Обновляем/добавляем запись о форме
	ЗаписьФормы = Новый Структура;
	ЗаписьФормы.Вставить("title", ДанныеФормы.title);
	ЗаписьФормы.Вставить("type", ДанныеФормы.form_type);
	ЗаписьФормы.Вставить("json_path", ИмяФайлаJSON);
	
	Если Объект.ГенерироватьMarkdown Тогда
		ИмяФайлаMD = СтрЗаменить(ИмяФайлаJSON, ".json", ".md");
		ЗаписьФормы.Вставить("markdown_path", ИмяФайлаMD);
	КонецЕсли;
	
	ЗаписьФормы.Вставить("collected_at", ДанныеФормы.metadata.collected_at);
	ЗаписьФормы.Вставить("element_count", ДанныеФормы.elements.Количество());
	ЗаписьФормы.Вставить("detail_level", ДанныеФормы.metadata.detail_level);
	
	Индекс.forms.Вставить(ДанныеФормы.form_name, ЗаписьФормы);
	Индекс.Вставить("updated_at", ТекущаяДатаСеанса());
	
	// Сохраняем индекс
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(, Символы.Таб));
	ЗаписатьJSON(ЗаписьJSON, Индекс);
	ТекстИндекса = ЗаписьJSON.Закрыть();
	
	ЗаписьТекста = Новый ЗаписьТекста(ПутьИндекса, КодировкаТекста.UTF8);
	ЗаписьТекста.Записать(ТекстИндекса);
	ЗаписьТекста.Закрыть();
КонецПроцедуры

#КонецОбласти

#Область АгентскийРежим

// Проверяет режим запуска обработки
//
// Возвращаемое значение:
//   Строка - "agent" или "interactive"
//
&НаКлиенте
Функция ПроверитьРежимЗапуска()
	Попытка
		ПутьКTaskJSON = ПолучитьПутьКTaskJSONНаСервере();
		ФайлTask = Новый Файл(ПутьКTaskJSON);
		
		Если ФайлTask.Существует() Тогда
			Возврат "agent";
		Иначе
			Возврат "interactive";
		КонецЕсли;
	Исключение
		Возврат "interactive";
	КонецПопытки;
КонецФункции

// Получает путь к файлу task.json
//
// Возвращаемое значение:
//   Строка - Путь к task.json
//
&НаСервере
Функция ПолучитьПутьКTaskJSONНаСервере()
	// Получаем путь к файлу обработки через экспортную функцию объекта
	ПутьКОбработке = РеквизитФормыВЗначение("Объект").ПолучитьПутьКФайлуОбработки();
	ФайлОбработки = Новый Файл(ПутьКОбработке);
	КаталогОбработки = ФайлОбработки.Путь;
	
	ПутьКTaskJSON = КаталогОбработки + "agent" + ПолучитьРазделительПути() + "task.json";
	
	Возврат ПутьКTaskJSON;
КонецФункции

// Выполняет агентский режим (автоматический сбор)
//
&НаКлиенте
Процедура ВыполнитьАгентскийРежим()
	// TODO: Реализация в Этапе 2
	СтатусСбора = "Агентский режим будет реализован в Этапе 2";
КонецПроцедуры

#КонецОбласти

#Область СистемаЛогирования

// Записывает сообщение в лог отладки
//
// Параметры:
//   Сообщение - Строка - Текст сообщения
//   Уровень - Строка - Уровень сообщения (INFO, ERROR, DEBUG)
//
&НаКлиенте
Процедура Лог(Сообщение, Уровень = "INFO")
	Если Не Объект.РежимОтладки Тогда
		Возврат;
	КонецЕсли;
	
	ЛогНаСервере(Сообщение, Уровень);
КонецПроцедуры

// Записывает сообщение в файл лога (серверная часть)
//
// Параметры:
//   Сообщение - Строка - Текст сообщения
//   Уровень - Строка - Уровень сообщения
//
&НаСервере
Процедура ЛогНаСервере(Сообщение, Уровень)
	Попытка
		// Получаем путь к файлу лога
		ПутьКОбработке = РеквизитФормыВЗначение("Объект").ПолучитьПутьКФайлуОбработки();
		ФайлОбработки = Новый Файл(ПутьКОбработке);
		КаталогОбработки = ФайлОбработки.Путь;
		
		ПутьКЛогу = КаталогОбработки + "debug.log";
		
		// Формируем строку лога
		ВремяМетка = Формат(ТекущаяДатаСеанса(), "ДФ='yyyy-MM-dd HH:mm:ss'");
		СтрокаЛога = СтрШаблон("[%1] [%2] %3", ВремяМетка, Уровень, Сообщение) + Символы.ПС;
		
		// Добавляем в файл
		ЗаписьТекста = Новый ЗаписьТекста(ПутьКЛогу, КодировкаТекста.UTF8, , Истина);
		ЗаписьТекста.Записать(СтрокаЛога);
		ЗаписьТекста.Закрыть();
		
	Исключение
		// Игнорируем ошибки записи лога - отказ логирования не должен прерывать основную работу
	КонецПопытки;
КонецПроцедуры

// Очищает файл лога
//
&НаСервере
Процедура ОчиститьЛог()
	Попытка
		ПутьКОбработке = РеквизитФормыВЗначение("Объект").ПолучитьПутьКФайлуОбработки();
		ФайлОбработки = Новый Файл(ПутьКОбработке);
		КаталогОбработки = ФайлОбработки.Путь;
		
		ПутьКЛогу = КаталогОбработки + "debug.log";
		
		ФайлЛога = Новый Файл(ПутьКЛогу);
		Если ФайлЛога.Существует() Тогда
			УдалитьФайлы(ПутьКЛогу);
		КонецЕсли;
	Исключение
		// Игнорируем ошибки очистки лога - некритичная операция
	КонецПопытки;
КонецПроцедуры

#КонецОбласти

#КонецОбласти
