# Техническое задание: Инструмент сбора контекста формы 1С для AI

**Дата:** 30.11.2023
**Версия:** 2.0
**Назначение:** Разработать функцию/обработку на платформе 1С, которая формирует текстовое описание (сериализацию) структуры формы в формате Markdown.
**Потребитель данных:** LLM-агент, генерирующий сценарии тестирования для Vanessa Automation.

## 1. Интерфейс функции

Функция должна принимать параметры:
1.  **`Форма`** (УправляемаяФорма) — контекст формы для анализа.
2.  **`ВыгружатьСкрытые`** (Булево) — режим работы.
    *   `Ложь` (по умолчанию) — режим "Только видимые". Скрытые элементы полностью игнорируются.
    *   `Истина` — режим "Полная структура". Скрытые элементы выгружаются с пометкой `{Hidden}`.

---

## 2. Формат выходных данных

Результат работы — текстовая строка, представляющая собой иерархический список.

### 2.1. Шаблон строки
```text
- [Тег] "Заголовок" (ИмяЭлемента) {Опции}
```

*   **Отступ:** 2 пробела для каждого уровня вложенности (табуляцию не использовать).
*   **[Тег]:** Классификатор типа элемента (см. Раздел 4).
*   **"Заголовок":** Текст интерфейса (см. Раздел 3.2).
*   **(ИмяЭлемента):** Имя элемента в метаданных (Name).
*   **{Опции}:** Дополнительные флаги (см. Раздел 5). Выводятся только при наличии.

---

## 3. Алгоритм обхода и фильтрации

Функция рекурсивно обходит коллекцию `Элементы`.

### 3.1. Логика Видимости (Важно)
Перед обработкой элемента проверяем свойство `Видимость` (Visible).

1.  **Если Видимость = Истина:**
    *   Элемент обрабатывается и добавляется в список.
    *   Рекурсия идет вглубь (для групп).
2.  **Если Видимость = Ложь:**
    *   Если режим `ВыгружатьСкрытые = Ложь` -> **Пропустить** элемент (Continue).
    *   Если режим `ВыгружатьСкрытые = Истина`:
        *   Элемент добавляется в список.
        *   В опции добавляется флаг `{Hidden}`.
        *   **ОПТИМИЗАЦИЯ:** Если скрытый элемент является группой (Группа, Страница, Вкладки), то его подчиненные элементы **НЕ обходятся** (рекурсия прерывается).
        *   *Причина:* Если скрыт контейнер, то содержимое недоступно. ИИ достаточно знать о наличии скрытой группы, не перегружая контекст.

### 3.2. Определение Заголовка
Текст в кавычках должен соответствовать тому, как элемент виден пользователю (или как к нему обращаться в сценарии):
1.  Свойство `Заголовок` (Title).
2.  Если пусто -> `Подсказка` (Tooltip) или `РасширеннаяПодсказка`.
3.  Если пусто -> `Имя` (Name), но писать его в кавычках.
4.  Для кнопок без текста (только картинка) -> Имя команды или описание картинки.

---

## 4. Маппинг Типов (1С -> Теги AI)

| Элемент 1С / Вид | Тег | Комментарий |
| :--- | :--- | :--- |
| **Контейнеры** | | |
| Группа (Вид=Страницы) | `[Pages]` | Группа вкладок. |
| Группа (Вид=Страница) | `[Tab]` | Конкретная вкладка. |
| Группа (Вид=ГруппаКнопок)| `[Menu]` | Кнопка с выпадающим меню (Popup), группа "Ещё". |
| Группа (Вид=КоманднаяПанель) | `[CmdBar]` | Панель кнопок. |
| Группа (Обычная) | `[Group]` | Рамка, Свертка, Обычная. |
| **Поля ввода** | | |
| Поле (Вид=ПолеВвода) | `[Input]` | Строка, Число, Дата, Ссылка. Требует `{Type}`. |
| Поле (Вид=ПолеФлажка) | `[Checkbox]`| Булево. **Не** требует `{Type}`. |
| Поле (Вид=ПолеПереключателя)| `[Radio]` | Радио-кнопки. |
| Поле (Вид=ПолеТекстовогоДок)| `[TextEditor]`| Многострочный текст. |
| Поле (Вид=ПолеHTMLДокумента)| `[HTML]` | HTML поле. |
| Поле (Вид=ПолеТабличногоДок)| `[Spreadsheet]`| Табличный документ (mxl). |
| Поле (Вид=ПолеКалендаря) | `[Calendar]` | |
| **Таблицы** | | |
| ТаблицаФормы | `[Table]` | Динамический список, ТЧ, Дерево. |
| Поле (Внутри таблицы) | `[Col]` | Колонка таблицы. |
| **Интерактив** | | |
| Кнопка | `[Button]` | |
| Декорация (Гиперссылка) | `[Link]` | |
| Декорация (Надпись) | `[Label]` | Статический текст (для проверок). |
| Декорация (Картинка) | `[Image]` | |

---

## 5. Дополнительные опции {Options}

Опции добавляются в конец строки в фигурных скобках через запятую. Если опций нет, скобки не пишутся.

### 5.1. Флаги состояния
*   **`*Required`**: Если `АвтоОтметкаНезаполненного = Истина`.
*   **`*ReadOnly`**: Если `ТолькоПросмотр = Истина` ИЛИ `Доступность = Ложь`.
*   **`{Hidden}`**: Если `Видимость = Ложь` (только в режиме "ВыгружатьСкрытые").

### 5.2. Типизация `{Type: ...}`
Применяется **только** для тегов `[Input]` и `[Col]`. Для остальных тегов тип не выводится (он понятен из тега).

*   **String**: Не выводить (значение по умолчанию).
*   **Number**: Выводить `{Type: Number}`.
*   **Date**: Выводить `{Type: Date}`.
*   **Boolean**: Выводить `{Type: Boolean}` (только если это ПолеВвода, а не Флажок).
*   **Ref**: Выводить `{Type: Catalog.Имя}` или `{Type: Ref}`, если можно определить тип ссылки через `ПутьКДанным`.

---

## 6. Специальные случаи обработки

1.  **Таблицы (`[Table]`):**
    *   Внутри таблицы необходимо найти группу (или кнопки), относящиеся к командной панели. Обернуть их в `[CmdBar]`.
    *   Все поля внутри таблицы помечать тегом `[Col]`.
2.  **Подменю (`[Menu]`):**
    *   Обязательно рекурсивно обходить группы с видом `ГруппаКнопок`. Это часто кнопки "Печать", "ЭДО", "Подменю".
3.  **Автозаполнение:**
    *   Если у формы `АвтозаполнениеКоманднойПанели = Истина`, по возможности добавить виртуальные кнопки `[Button] "Провести и закрыть"` и `[Button] "Записать"` в начало главной панели.

---

## 7. Эталонный пример результата (Mode: ВыгружатьСкрытые = Истина)

*Примечание: Имена метаданных на русском языке.*

```markdown
# Form: ДокументЗаказПоставщикуФорма
- [CmdBar] "Командная панель" (ФормаКоманднаяПанель)
  - [Button] "Провести и закрыть" (ФормаПровестиИЗакрыть)
  - [Button] "Записать" (ФормаЗаписать)
  - [Menu] "Печать" (ГруппаПечать)
    - [Button] "Заказ поставщику" (ПечатьЗаказа)
- [Group] "Шапка" (ГруппаШапка)
  - [Input] "Поставщик" (Контрагент) *Required {Type: Catalog.Counterparties}
  - [Input] "Договор" (Договор) {Type: Catalog.Contracts}
  - [Checkbox] "Налогообложение НДС" (НалогообложениеНДС)
  - [Input] "Валюта" (Валюта) *ReadOnly {Type: Catalog.Currencies}
- [Pages] "Страницы" (ГруппаСтраницы)
  - [Tab] "Товары" (ГруппаТовары)
    - [Table] "Товары" (Товары)
      - [CmdBar] "Командная панель" (ТоварыКоманднаяПанель)
        - [Button] "Добавить" (ТоварыДобавить)
        - [Button] "Загрузить из ТСД" (ТоварыЗагрузить)
      - [Col] "N" (НомерСтроки)
      - [Col] "Номенклатура" (Номенклатура) *Required {Type: Catalog.Products}
      - [Col] "Код" (КодАртикул) {Hidden}
      - [Col] "Количество" (Количество) {Type: Number}
      - [Col] "Цена" (Цена) {Type: Number}
      - [Col] "Сумма" (Сумма) *ReadOnly {Type: Number}
  - [Tab] "Доставка" (ГруппаДоставка) {Hidden}
  - [Tab] "Дополнительно" (ГруппаДополнительно)
    - [Input] "Ответственный" (Менеджер) {Type: Catalog.Users}
    - [Label] "Автор документа: Иванов И.И." (ДекорацияАвтор)
```